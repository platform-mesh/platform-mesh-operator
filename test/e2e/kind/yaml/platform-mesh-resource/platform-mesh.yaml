apiVersion: core.platform-mesh.io/v1alpha1
kind: PlatformMesh
metadata:
  name: platform-mesh
  namespace: platform-mesh-system
spec:
  infra:
    enable: true
  exposure:
    port: 8443
  ocm:
    repo:
      name: platform-mesh
    component:
      name: platform-mesh
    referencePath: []
  featureToggles:
   - name: "feature-enable-getting-started"
  values:
    keycloak:
      enabled: true
      values:
        service:
          clusterIP: 10.96.0.110
        resources:
          limits:
            cpu: "2"
            ephemeral-storage: 2Gi
            memory: 2Gi
          requests:
            cpu: 750m
            ephemeral-storage: 50Mi
            memory: 1Gi
    crossplane:
      values:
        provider:
          packages:
            - xpkg.upbound.io/crossplane-contrib/provider-keycloak:v2.7.2
    infra:
      dependsOn:
        - name: kcp-operator
          namespace: default
      values:
        cors:
          enabled: true
          accessControlAllowOriginList:
          - "http://localhost:4200"
          - "http://localhost:4300"
          - "http://*.localhost:4200"
          - "http://*.localhost:4300"
          - "https://portal.dev.local:8443"
          - "https://*.portal.dev.local:8443"
        gatewayApi:
          enabled: true
        mailpit:
          enabled: true
        hostAliases:
          enabled: true
        kcp:
          rootShard:
            extraArgs:
              - --feature-gates=WorkspaceAuthentication=true
              - --shard-virtual-workspace-url=https://kcp.api.portal.dev.local:6443
          webhook:
            enabled: true
          frontProxy:
            clusterIP: "10.96.0.100"
        keycloak:
          crossplane:
            clients:
              welcome:
                validRedirectUris:
                  - "http://localhost:8000/callback*"
                  - "http://localhost:4300/callback*"
                  - "https://*"
    kcp:
      enabled: false
    kcp-operator:
      enabled: true
      imageResource:
        enabled: true
        labels:
          infra: "true"
          component: infra
    security-operator:
      values:
        baseDomain: "portal.dev.local:8443"
        initializer:
          extraArgs:
            - --idp-smtp-server=mailpit.platform-mesh-system.svc.cluster.local
            - --idp-smtp-port=1025
            - --idp-from-address=keycloak@portal.dev.local
            - --domain-ca-lookup
            - --idp-additional-redirect-urls="https://default.portal.dev.local:3000/callback*"
        caSecret: domain-certificate-ca
        hostAliases:
          enabled: true
    portal:
      enabled: true
      values:
        gatewayApi:
          enabled: true
          httpRoute:
            parentRefs:
            - name: k8sapi-gateway
              sectionName: websecure
              kind: Gateway
        extraEnvVars:
          - name: OPENMFP_PORTAL_CONTEXT_IAM_SERVICE_API_URL
            value: https://${org-subdomain}portal.dev.local:8443/iam/graphql
          - name: OPENMFP_PORTAL_CONTEXT_CRD_GATEWAY_API_URL
            value: "https://${org-subdomain}portal.dev.local:8443/api/kubernetes-graphql-gateway/root:orgs:${org-name}/graphql"
          - name: NODE_EXTRA_CA_CERTS
            value: /etc/ssl/certs/domain-ca.crt
        extraVolumes:
          - name: domain-ca
            secret:
              secretName: domain-certificate-ca
        extraVolumeMounts:
          - name: domain-ca
            mountPath: /etc/ssl/certs/domain-ca.crt
            subPath: tls.crt
            readOnly: true
        hostAliases:
          enabled: true
    openfga:
      enabled: true
      values:
        datastore:
          uri: "postgres://postgres:password@openfga-postgres.platform-mesh-system.svc.cluster.local:5432/postgres?sslmode=disable"
        postgresql:
          auth:
            postgresPassword: password
            database: postgres
        telemetry:
          trace:
            enabled: true
            otlp:
              endpoint: observability-opentelemetry-collector.observability.svc.cluster.local:4317
              tls:
                enabled: false
    virtual-workspaces:
      values:
        virtualWorkspaceSecretName: virtual-workspaces-cert
        deployment:
          serverUrl: "https://frontproxy-front-proxy.platform-mesh-system:6443"
          resourceSchemaName: "v250704-6d57f16.contentconfigurations.ui.platform-mesh.io"
          resourceSchemaWorkspace: "root:platform-mesh-system"
    kubernetes-graphql-gateway:
      enabled: true
      values:
        cors:
          enabled: true
        gatewayApi:
          enabled: true
        listener:
          virtualWorkspacesConfig:
            content:
              virtualWorkspaces:
                - kubeconfig: /app/kubeconfig/kubeconfig
                  name: contentconfigurations
                  url: https://frontproxy-front-proxy.platform-mesh-system:6443/services/contentconfigurations
                - kubeconfig: /app/kubeconfig/kubeconfig
                  name: marketplace
                  url: https://frontproxy-front-proxy.platform-mesh-system:6443/services/marketplace
            enabled: true
    iam-service:
      enabled: false
      values:
        cors:
          enabled: true
        hostAliases:
          enabled: true
        caSecret: domain-certificate-ca
        gatewayApi:
          enabled: true
        istio:
          enabled: false
    iam-ui:
      enabled: false
      values:
        gatewayApi:
          enabled: true
        istio:
          enabled: false
    marketplace-ui:
      enabled: false
      values:
        gatewayApi:
          enabled: true
        istio:
          enabled: false
