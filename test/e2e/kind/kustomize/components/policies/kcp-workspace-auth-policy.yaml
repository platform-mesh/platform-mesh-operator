apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kcp-workspace-authentication-feature-gate
  annotations:
    policies.kyverno.io/title: KCP WorkspaceAuthentication Feature Gate
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/subject: Deployment
    policies.kyverno.io/description: >-
      Ensures the root-kcp deployment includes the WorkspaceAuthentication feature gate.
spec:
  validationFailureAction: Enforce
  mutateExistingOnPolicyUpdate: true
  background: true
  rules:
    - name: ensure-workspace-authentication-feature-gate
      match:
        any:
          - resources:
              kinds:
                - Deployment
              names:
                - root-kcp
              namespaces:
                - platform-mesh-system
      mutate:
        targets:
          - apiVersion: apps/v1
            kind: Deployment
            name: root-kcp
            namespace: platform-mesh-system
        patchesJson6902: |-
          - op: add
            path: /spec/template/spec/containers/0/args/-
            value: --feature-gates=WorkspaceAuthentication=true
